# Примитивная база данных

## Содержание

1. [Обзор проекта](#обзор-проекта)
2. [Требования](#требования)
3. [Установка](#установка)
4. [Использование](#использование)
5. [Архитектура](#архитектура)
6. [Команды](#команды)
7. [Поддерживаемые типы данных](#поддерживаемые-типы-данных)
8. [CRUD-операции](#crud-операции)
9. [Декораторы и замыкания](#декораторы-и-замыкания)
10. [Структура проекта](#структура-проекта)
11. [Разработка](#разработка)
12. [Обработка ошибок](#обработка-ошибок)

## Обзор проекта

Примитивная база данных - это консольное приложение для управления таблицами с поддержкой полного набора CRUD-операций (Create, Read, Update, Delete). Проект реализует базовую систему управления данными с персистентным хранением в JSON-файлах.

Основные возможности:
- Создание, просмотр и удаление таблиц
- Автоматическое управление первичными ключами (ID)
- Полный набор CRUD-операций над данными
- Валидация типов данных
- Персистентное хранение метаданных и данных
- Красивый табличный вывод с использованием PrettyTable
- Декораторы для обработки ошибок, логирования и подтверждения действий
- Замыкания для кэширования запросов

## Требования

- Python 3.12 или выше
- Poetry для управления зависимостями
- Git для контроля версий

## Установка

### Установка из исходного кода

```bash
# Клонирование репозитория
git clone <repository-url>
cd primitive_bd

# Установка зависимостей через Poetry
make install
```

### Установка как пакета

```bash
# Сборка пакета
make build

# Установка пакета
make package-install
```

## Использование

### Запуск приложения

```bash
# Через Poetry
make run

# Через Python модуль
poetry run python -m src.primitive_db.main

# После установки пакета
database
```

## Архитектура

Проект реализован с использованием модульной архитектуры, состоящей из следующих компонентов:

### Основные модули:

1. **engine.py** - основной движок приложения
   - Обработка пользовательского ввода с использованием библиотеки `prompt`
   - Парсинг и валидация команд
   - Управление жизненным циклом приложения
   - Координация работы между модулями

2. **core.py** - бизнес-логика
   - Создание, удаление и просмотр таблиц
   - CRUD-операции над данными (insert, select, update, delete)
   - Валидация данных и типов
   - Форматирование вывода с использованием PrettyTable

3. **utils.py** - работа с файловой системой
   - Загрузка и сохранение метаданных таблиц
   - Работа с данными таблиц (отдельные JSON-файлы)
   - Управление директорией данных

4. **parser.py** - парсинг сложных команд
   - Разбор условий WHERE и SET
   - Парсинг значений для INSERT
   - Преобразование строковых значений в типы Python

5. **decorators.py** - декораторы и замыкания
   - Обработка ошибок базы данных
   - Подтверждение опасных операций
   - Логирование времени выполнения
   - Кэширование запросов через замыкания

6. **main.py** - точка входа
   - Инициализация приложения
   - Запуск основного цикла

## Команды

### Управление таблицами

| Команда | Описание | Формат | Пример |
|---------|----------|--------|---------|
| `create_table` | Создание новой таблицы | `create_table <имя> <столбец1:тип> ...` | `create_table users name:str age:int` |
| `list_tables` | Просмотр списка таблиц | `list_tables` | `list_tables` |
| `drop_table` | Удаление таблицы | `drop_table <имя>` | `drop_table users` |
| `info` | Информация о таблице | `info <имя>` | `info users` |

### CRUD-операции

| Команда | Описание | Формат | Пример |
|---------|----------|--------|---------|
| `insert into` | Добавление записи | `insert into <таблица> values (<знач1>, ...)` | `insert into users values ("Иван", 25, true)` |
| `select from` | Выборка записей | `select from <таблица> [where <условие>]` | `select from users where age = 25` |
| `update` | Обновление записей | `update <таблица> set <столбец>=<знач> where <условие>` | `update users set age = 26 where name = "Иван"` |
| `delete from` | Удаление записей | `delete from <таблица> where <условие>` | `delete from users where id = 1` |

### Служебные команды

| Команда | Описание |
|---------|----------|
| `help` | Справка по командам |
| `exit` | Выход из программы |

## Поддерживаемые типы данных

Проект поддерживает три базовых типа данных:

1. **int** - целочисленные значения
   - Пример: `age:int`
   - Использование: числовые данные без дробной части
   - Формат ввода: `25`

2. **str** - строковые значения
   - Пример: `name:str`
   - Использование: текстовые данные произвольной длины
   - Формат ввода: `"Иван Иванов"` или `Иван` (без пробелов)

3. **bool** - логические значения
   - Пример: `is_active:bool`
   - Использование: логические флаги
   - Формат ввода: `true` или `false`

**Важно**: Каждая таблица автоматически получает столбец `ID:int` в качестве первичного ключа. Значение ID генерируется автоматически при добавлении записей.

## CRUD-операции

### INSERT - добавление записей

Добавляет новую запись в таблицу. Значения должны соответствовать типам столбцов (без учета автоматического ID).

```
insert into <table_name> values (<value1>, <value2>, ...)
```

Примеры:
```bash
insert into users values ("Sergei", 28, true)
insert into products values ("Laptop", 1500, true)
```

### SELECT - выборка записей

Возвращает записи из таблицы. Может использоваться с условием WHERE или без него.

```
select from <table_name>
select from <table_name> where <column> = <value>
```

Примеры:
```bash
select from users
select from users where age = 28
select from products where price > 1000
```

### UPDATE - обновление записей

Обновляет записи, соответствующие условию WHERE.

```
update <table_name> set <column1> = <new_value> where <condition_column> = <condition_value>
```

Примеры:
```bash
update users set age = 29 where name = "Sergei"
update products set price = 1400 where title = "Laptop"
```

### DELETE - удаление записей

Удаляет записи, соответствующие условию WHERE.

```
delete from <table_name> where <column> = <value>
```

Примеры:
```bash
delete from users where ID = 1
delete from products where in_stock = false
```

### INFO - информация о таблице

Отображает метаинформацию о таблице: структуру столбцов и количество записей.

```
info <table_name>
```

Пример:
```bash
info users
# Вывод:
# Таблица: users
# Столбцы: ID:int, name:str, age:int, is_active:bool
# Количество записей: 5
```

## Декораторы и замыкания

### Декоратор @handle_db_errors
Централизованная обработка ошибок базы данных:
- Автоматически перехватывает `FileNotFoundError`, `KeyError`, `ValueError` и другие исключения
- Выводит понятные сообщения об ошибках
- Позволяет избежать дублирования try-except блоков

### Декоратор @confirm_action
Подтверждение опасных операций:
- Запрашивает подтверждение у пользователя перед выполнением
- Применен к командам `drop_table` и `delete`
- Пример использования: `Вы уверены, что хотите выполнить "удаление таблицы" таблицы "users"? [y/n]:`

### Декоратор @log_time
Логирование времени выполнения операций:
- Измеряет время выполнения функций
- Выводит сообщение если операция заняла более 0.1 секунды
- Применен к операциям `insert` и `select`

### Замыкание для кэширования
Механизм кэширования результатов запросов:
- Использует замыкание для хранения кэша в памяти
- Кэширует результаты одинаковых SELECT запросов
- Уменьшает количество обращений к файловой системе
- Автоматически управляет жизненным циклом кэша

### Преимущества использования декораторов:
1. **Централизованная обработка ошибок** - единый подход к обработке исключений
2. **Повышенная безопасность** - подтверждение опасных операций
3. **Мониторинг производительности** - отслеживание времени выполнения
4. **Улучшенная производительность** - кэширование часто используемых данных
5. **Чистый и читаемый код** - разделение ответственности
6. **Легкость расширения** - добавление новой функциональности через декораторы

## Формат вывода данных

При выполнении SELECT команды данные выводятся в виде красиво отформатированной таблицы:

```
+----+---------+-----+-----------+
| ID |  name   | age | is_active |
+----+---------+-----+-----------+
| 1  | Sergei  | 28  |    True   |
| 2  |  Maria  | 25  |    True   |
| 3  |  Alex   | 30  |   False   |
+----+---------+-----+-----------+
```

## Структура проекта

```
primitive_bd/
├── pyproject.toml              # Конфигурация Poetry и зависимости
├── README.md                   # Документация
├── Makefile                    # Автоматизация задач
├── db_meta.json                # Файл метаданных (создается автоматически)
│
├── src/                        # Исходный код
│   ├── __init__.py
│   ├── decorators.py           # Декораторы и замыкания
│   └── primitive_db/           # Основной пакет
│       ├── __init__.py
│       ├── main.py             # Точка входа
│       ├── engine.py           # Движок приложения
│       ├── core.py             # Бизнес-логика (CRUD операции)
│       ├── utils.py            # Работа с файлами
│       └── parser.py           # Парсинг команд
│
├── data/                       # Данные таблиц
│
├── dist/                       # Собранные пакеты (после poetry build)
└── .gitignore                  # Игнорируемые файлы Git
```

### Файлы данных

#### Метаданные (`db_meta.json`)
Хранит информацию о структуре всех таблиц

Пример:
```json
{
  "users": {
    "columns": [
      {"name": "ID", "type": "int"},
      {"name": "name", "type": "str"},
      {"name": "age", "type": "int"},
      {"name": "is_active", "type": "bool"}
    ]
  }
}
```

#### Данные таблиц (`data/<table_name>.json`)
Каждая таблица имеет свой файл данных

Пример:
```json
[
  {
    "ID": 1,
    "name": "Sergei",
    "age": 28,
    "is_active": true
  },
  {
    "ID": 2,
    "name": "Maria",
    "age": 25,
    "is_active": true
  }
]
```

## Разработка

### Зависимости

Основные зависимости указаны в `pyproject.toml`:
- `prompt` - для интерактивного ввода команд
- `prettytable` - для красивого форматирования вывода таблиц

### Сборка проекта

```bash
# Проверка кода
make lint

# Сборка пакета
make build

# Установка локально
make package-install
```

### Автоматизация с Makefile

Проект включает Makefile с наиболее часто используемыми командами:

```bash
make install          # Установка зависимостей
make run              # Запуск приложения
make lint             # Проверка качества кода (ruff)
make build            # Сборка пакета (poetry build)
make package-install  # Установка собранного пакета
make publish          # Пробная публикация без загрузки в PyPI
make help             # Справка по командам
```

### Пример полного рабочего процесса

```bash
# Создание и заполнение таблицы
make run
# В интерактивном режиме:
create_table users name:str age:int is_active:bool
insert into users values ("Иван", 25, true)
insert into users values ("Мария", 30, false)
select from users
update users set age = 26 where name = "Иван"
info users
exit
```

## Обработка ошибок

Приложение включает обработку следующих ошибок:

### Ошибки валидации
- `Таблица "users" уже существует.` - при попытке создать существующую таблицу
- `Таблица "products" не существует.` - при работе с несуществующей таблицей
- `Некорректное значение: "name". Используйте формат "имя:тип".` - неверный формат столбца
- `Неверное количество значений. Ожидается: 3, получено: 2.` - несоответствие числа значений
- `Несоответствие типов данных.` - значение не соответствует типу столбца

### Ошибки синтаксиса
- `Функции 'unknown_command' нет. Попробуйте снова.` - неизвестная команда
- `Ошибка: Неверный формат команды.` - синтаксическая ошибка в команде
- `Ошибка: Отсутствует ключевое слово WHERE.` - пропущено обязательное ключевое слово

### Ошибки данных
- `Записи не найдены по заданному условию.` - условие WHERE не соответствует ни одной записи
- `Таблица "users" пуста.` - попытка работы с пустой таблицей

### Системные ошибки
- `Ошибка ввода: команда не может быть пустой.` - пустой ввод
- `Неожиданная ошибка: <описание>` - непредвиденная ошибка выполнения

Все ошибки сопровождаются понятными сообщениями и не приводят к аварийному завершению программы. После ошибки приложение продолжает работу, ожидая следующую команду.
